<template x-if="loading">
  <div class="flex items-center justify-center py-12">
    <div class="text-center">
      <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-gray-600 dark:text-gray-400">Loading external wikis...</p>
    </div>
  </div>
</template>

<template x-if="!loading">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <a href="#/" @click.prevent="$root.navigate('')" class="inline-block px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 mb-4">
        ← ホームに戻る
      </a>
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-2">🌐 外部Wikiインデックス</h1>
          <p class="text-gray-600 dark:text-gray-400">
            外部のWikiを登録・管理します
          </p>
        </div>
        <button @click="toggleAddForm()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          <span x-show="!showAddForm">➕ Wikiを追加</span>
          <span x-show="showAddForm">キャンセル</span>
        </button>
      </div>
    </div>

    <!-- Error -->
    <template x-if="error">
      <div class="mb-4 p-4 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-700 text-red-700 dark:text-red-300 rounded-lg">
        <span x-text="error"></span>
      </div>
    </template>

    <!-- Add External Wiki Form -->
    <div x-show="showAddForm" x-transition class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">外部Wikiを追加</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Wiki ID</label>
          <input
            type="text"
            x-model="newWikiId"
            placeholder="例: my-wiki"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-800 outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Wikiタイトル</label>
          <input
            type="text"
            x-model="newTitle"
            placeholder="例: My Friend's Wiki"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-800 outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">説明</label>
          <textarea
            x-model="newDescription"
            placeholder="このWikiについての説明..."
            rows="3"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-800 outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
          ></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">アクセスURL</label>
          <input
            type="url"
            x-model="newAccessUrl"
            placeholder="例: https://script.google.com/macros/s/XXX/exec"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-800 outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">タグ（カンマ区切り）</label>
          <input
            type="text"
            x-model="newTags"
            placeholder="例: tech, programming, friends"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:focus:ring-purple-800 outline-none bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100"
          />
        </div>
        <button
          @click="addExternalWiki()"
          :disabled="loading"
          class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span x-text="loading ? '追加中...' : '追加'"></span>
        </button>
      </div>
    </div>

    <!-- External Wiki List -->
    <template x-if="externalWikis.length === 0">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 text-center">
        <div class="text-6xl mb-4">🌐</div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-2">
          外部Wikiが登録されていません
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">
          外部Wikiをインデックスに登録して、連合ネットワークを拡張しましょう。
        </p>
        <button @click="toggleAddForm()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          最初のWikiを追加
        </button>
      </div>
    </template>

    <template x-if="externalWikis.length > 0">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
            登録済み外部Wiki (<span x-text="externalWikis.length"></span>)
          </h2>
        </div>
        <div class="divide-y divide-gray-200 dark:divide-gray-700">
          <template x-for="wiki in externalWikis" :key="wiki.wikiId">
            <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-1" x-text="wiki.title"></h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mb-2" x-text="wiki.description || '説明なし'"></p>
                  <div class="flex items-center space-x-4 mb-2">
                    <span class="text-xs text-gray-500 dark:text-gray-500">
                      Wiki ID: <span class="font-mono" x-text="wiki.wikiId"></span>
                    </span>
                    <span class="text-xs text-gray-500 dark:text-gray-500">
                      登録日: <span x-text="formatDate(wiki.registeredAt)"></span>
                    </span>
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-500 mb-2" x-text="wiki.accessUrl"></p>
                  <template x-if="wiki.tags">
                    <div class="flex flex-wrap gap-1">
                      <template x-for="tag in wiki.tags.split(',').map(t => t.trim()).filter(Boolean)" :key="tag">
                        <span class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full" x-text="tag"></span>
                      </template>
                    </div>
                  </template>
                </div>
                <button
                  @click="removeExternalWiki(wiki.accessUrl)"
                  class="ml-4 px-3 py-1 text-sm text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                >
                  🗑️ 削除
                </button>
              </div>
            </div>
          </template>
        </div>
      </div>
    </template>

    <!-- Info Box -->
    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-300 mb-2">💡 外部Wikiインデックスについて</h3>
      <p class="text-sm text-blue-700 dark:text-blue-400">
        外部Wikiをインデックスに登録すると、そのWikiの存在を他のノードに伝えることができます。
        インデックスは分散型のWikiディレクトリとして機能し、ネットワーク内のWikiの発見を容易にします。
      </p>
    </div>
  </div>
</template>
