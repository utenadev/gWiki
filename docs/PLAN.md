# 開発計画: 分散型 GAS Wiki

## ビジョン
Google Apps Script (GAS) と Google Spreadsheets を使用した、分散型（連合型）Wikiシステムを構築する。
必要に応じてデータを取得（Pull）するのではなく、ノード（ユーザー）間で「Push型」のゴシッププロトコル（Nostr/ActivityPubに類似）を用いて更新情報を交換し、データの可用性と所有権を確保する。

## Phase 1: 連合の基礎 (ゴシッププロトコル)
目標: 2つのGASノード間で記事の更新を自動的に交換できるようにする。

- [x] **ピア管理 (Backend)**
    - [x] DBに `Peers` シートを作成し、信頼する隣人のURLを保存する。
    - [x] `addPeer`, `removePeer`, `getPeers` 関数を実装する。
- [x] **Inbox & Outbox (Backend)**
    - [x] **Outbox**: `createPage`/`updatePage` 実行時に、すべてのピアへ更新をプッシュする「ゴシップ」処理を追加する。
    - [x] **Inbox**: 外部からのJSON更新を受け付けるAPIエンドポイント (`action=gossip`) を作成する。
    - [x] **ストレージ**: 受信した外部ページを別のキャッシュ（`Cache` シート）に保存する。
- [ ] **基本認証/セキュリティ**
    - [ ] ピア間のスパムを防ぐための、シンプルな共有シークレットまたはAPIキーメカニズム。

## Phase 2: フロントエンド統合
目標: 連合の状態をUIで可視化する。

- [x] **ピア管理 UI**
    - [x] バックエンドAPI実装完了 (`addPeer`, `getPeers`)
    - [x] ピアURLを追加・削除するための設定ページ。
    - [x] ピアのステータス表示（アクティブ/非アクティブ、最終同期時刻）
    - [x] ピア削除機能
- [x] **連合コンテンツ表示**
    - [ ] 検索結果に「キャッシュ済み/外部」ページを表示する。
    - [ ] 外部コンテンツであることをUIで明確に示す（例: "From: User B"）。
    - [ ] WikiLink `[UserB/PageTitle]` を、キャッシュされた外部コンテンツへ解決する。
- [x] **Alpine.js移行完了** (2026-01-17)
    - [x] React → Alpine.js 3.14.0
    - [x] Hashベースルーティング実装
    - [x] 全ページコンポーネント移行
    - [x] テーマ切り替え機能
- [x] **現在のタスク**: ピア管理UI実装 (完了)
    - [x] ピア一覧ページの作成
    - [x] ピア追加モーダル/フォーム
    - [x] ピア同期ステータスの表示
    - [x] ピア削除機能

## Phase 2.5: データ構造の最適化とテスト環境 (2026-01-18)

### 目標
- [x] ローカル開発でのテスト容易性を向上させる（Mock導入）。
- [x] ページ階層化とアクセス制御を見据えた、データ格納構造の「ポリシーベース分割」を実装する。

### アーキテクチャ変更: ポリシーベース・パーティショニング
「ディレクトリ名」ではなく「アクセスポリシー」に基づいて格納先シートを分割する。

- [x] **メタデータ管理**:
    - すべてのページのメタデータ（ID, タイトル, パス, ポリシーID, 作成日時など）は `Pages` シート（または `Index` シート）で一元管理する。
    - パス（ディレクトリ構造）はこのメタデータ内で文字列として保持する（例: `admin/secret_page`）。
- [x] **コンテンツ格納 (Data Store)**:
    - コンテンツ（本文）はポリシーごとに異なるシートに保存する。
    - `Store_Public`: 誰でも閲覧可能なページのコンテンツ。
    - `Store_Admin`: 管理者のみ閲覧可能なページのコンテンツ。
    - `Store_GroupA`: 特定グループのみ閲覧可能なページのコンテンツ。
- [x] **メリット**:
    - ディレクトリが無数に増えても、シート数は「ポリシーの数」に抑えられる。
    - アクセス権限のチェックがシートレベルで物理的に分離され、堅牢になる（将来的にシート自体の保護機能とも連動しやすい）。

### 実装ステップ
1.  [x] **テスト環境構築**:
    - GAS固有オブジェクト（SpreadsheetApp等）のMockを作成。
    - `bun test` でDBロジックをテスト可能にする。
2.  [x] **DBロジック改修**:
    - `Pages` シートをインデックス専用に変更（Contentカラムを分離、またはPolicyカラムを追加）。
    - コンテンツ読み書き時に、ポリシーに応じたシート（`Store_*`）を選択するロジックを実装。
    - 既存データへの後方互換性または移行スクリプトを考慮。
3.  [x] **階層化対応**:
    - ページ作成/編集時に「パス（スラッシュ区切り）」を受け入れられるようにする。
    - パスに基づいて適切なポリシー（デフォルトルール）を適用するロジックを追加（例: `admin/*` -> `Store_Admin`）。

## Phase 3: 信頼性とスケーラビリティ (リレーモデル)
目標: GASの実行制限を克服し、より大きなネットワークをサポートする。

- [ ] **非同期伝播**
    - [ ] GASトリガー（時間ベースまたはイベントベース）を使用して、Outboxキューを非同期に処理する。
    - [ ] 多数のピアへの送信によるタイムアウトを防ぐ。
- [ ] **競合解決**
    - [ ] 同時編集やバージョンの競合を処理する（例: タイムスタンプに基づく Last Write Wins）。
- [ ] **署名 (推奨)**
    - [ ] 更新の真正性を検証するための、シンプルな暗号署名（またはハッシュ検証）の実装。

## Phase 4: リレーノード
- [ ] フロントエンドUIを持たず、メッセージの保存と転送のみを行い、コミュニティのハブとして機能する特化型「リレー」モードを作成する。
## Phase 5: Google Drive API based Wiki (2026-01-17) 🆕 NEW!

### 新規アーキテクチャ: Google Drive API を活用したWiki システムを実装する

### 目標
Google Drive 上の SpreadSheet ファイルを Wiki として管理するシステムを実装する
- パターン1: ローカルWiki（個人利用）
- パターン2: Workspace 共有（Google Workspace ドメイン内共有）
- パターン3: インターネット共有 + 外部 INDEX

### データフロー
```
Google Drive
├── my-wiki.ods (個人Wiki)
└─ Shared Drive/
    └─ team-wiki.ods (Workspace 共有)
      ↓ URLで読み込み
   [GAS - 行単位読み込み + レンダリング]
      ↓
   HTMLを返す
```

### ACL 取り扱い
- Google Drive の共有設定をそのまま使用
- 個人Wiki: 自分のみ read/write
- 共有Wiki: ACL 設設定に従う（read only、編集可、非公開）
- アクセス権限エラーを適切にハンドリング

### 外部 INDEX システム（Nostrリレーレーバー風）

#### External_Index シート構造
```
External_Index シート
├── wiki_id
├── title
├── description
├── access_url
├── registered_at
├── updated_at
└── is_public
```

### 外部INDEXの更新フロー
```
ページ表示時:
1. そのWikiの外部INDEXを検索
2. 登録されていればキャッシュを使う
3. されているいなければ、直接URLを開いて表示
4. 自分の外部INDEXに登録するか確認
```

### 実装方針

#### Google Drive API と OAuth2 の有無
- **必要ない**
- `SpreadsheetApp.openByUrl()` で十分
- ACL は Google Drive の共有設定をそのまま活用

#### 実装に追加する機能
- Wiki 選択 UI（どのWikiを開くかを選択）
- 外部 INDEX 管理（外部 Wiki の登録・更新）
- すべて URL ベースで SpreadSheet を開いてレンダリング
- ACL エラーハンドリング

### 注意点

- 既存の P2P Gossip プロトコルは維持（パターン3用プラグインとして実装済み）
- 既存 SpreadSheet DB 実装は残す（バックアップ、比較用）
- 既存の機能を維持しつつつつ新しい機能を追加
- Google Workspace 環境でのみ動作する機能を明確にする

### 実装ステップ

### Step 1: 基礎実装
- 外部 INDEX シートの作成
- URL 経由のデータ読み込み
- ACL チェック

### Step 2: Wiki 選択 UI 実装
- 複数の Wiki 一覧表示
- URL 入力によるWiki選択

### Step 3: テスト実装
- Google Workspace テスト
- Google Drive テスト
- ACL テスト

## 注意点

- 既存の P2P Gossip プロトコルは維持（パターン3 用プラグインとして実装済み）
- 既存 SpreadSheet DB 実装は残す（バックアップ、比較用）
- Google Workspace 環境でのみ動作する機能を明確にする