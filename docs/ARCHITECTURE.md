# アーキテクチャ: 分散型 GAS Wiki

## コアコンセプト: "Push型情報交換"

従来の分散Wikiがデータの「プル（取得）」に頼るのに対し、本システムは **Push/Gossipモデル** を採用します。

**インスピレーション:** Nostr, ActivityPub.

1.  **即時性**: ピアから送られたデータはローカルのキャッシュシートに保存されるため、閲覧時に外部へのリクエストが発生しません。
2.  **可用性**: 発信元のノードが停止していても、データをリレー・キャッシュしているピアが存在すればコンテンツを継続して閲覧可能です。
3.  **GASの最適化**: リアルタイムな外部取得を避け、バックグラウンドでのPush受信とローカル読み込みに特化することで、GASの実行時間制限を回避します。

---

## システム構成

### 1. ノード
各ユーザーのGASプロジェクトとSpreadsheetが1つの独立したノードとなります。

### 2. データストレージ (Google Spreadsheet)

データは「インデックス（メタデータ）」と「ストア（実データ）」に物理的に分離して格納されます。

#### A. Index (インデックス)
- **`Pages` シート**: 自分のノードにある全ページのパス、ID、アクセスポリシー、タイトル等のメタデータを管理します。
- **目的**: ページ一覧の高速な読み込みと、パスベースのルーティングを実現します。

#### B. Data Stores (データストア)
- **`Store_Public`, `Store_Admin` 等**: コンテンツ（本文）をアクセスポリシーごとに別シートに格納します。
- **メリット**:
    - **物理的隔離**: 管理者専用ページと公開ページのデータが混ざりません。
    - **柔軟性**: ディレクトリ構造が複雑になっても、シート数はポリシーの数に依存するため、Spreadsheetの管理が容易です。

#### C. Federated Data (連合データ)
- **`Peers`**: 信頼する隣人ノードのリスト。
- **`Cache`**: 他のノードから受信したコンテンツのキャッシュ。
- **`External_Index`**: ネットワーク上の他のWikiの所在情報。

---

## 通信プロトコル

### 投稿 (Outbox)
1.  **保存**: `Pages` (Index) と対応する `Store_*` にデータを書き込みます。
2.  **ポリシー判定**: ページのパス（例: `admin/secret`）から、適切なストアシートを自動選択します。
3.  **ゴシップ**: 信頼済みピアリストを巡回し、JSON形式で更新内容をPush送信します。

### 受信 (Inbox)
1.  **エンドポイント**: `doPost?path=gossip` で受信。
2.  **永続化**: 受信したデータを `Cache` シートに保存。

---

## セキュリティと階層化

### パスベースのポリシー管理
ページ作成時に指定するパスによって、格納先ポリシーが決定されます。
- `admin/` プレフィックス → `admin` ポリシー (`Store_Admin` シート)
- それ以外 → `public` ポリシー (`Store_Public` シート)

### 認証 (予定)
現在はGASのWeb App公開設定（Anyone / Me）に依存していますが、今後はピア間の **Bearer Token認証** を導入し、ゴシッププロトコルにおける送信元の真正性を保証します。